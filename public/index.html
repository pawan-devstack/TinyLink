<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TinyLink Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .fade-alert { opacity: 1; transition: opacity 0.7s; position: fixed; top: 18px; right: 18px; z-index: 10000; }
    .fade-alert.hide { opacity: 0; pointer-events: none; }
    .short-link-wrap { display: flex; align-items: center; gap: 7px; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="display-5 text-primary text-center mb-4">TinyLink Dashboard</h1>
    <form id="add-link-form" class="row g-3 justify-content-center mb-4">
      <div class="col-md-6">
        <input type="text" id="url" class="form-control" placeholder="Long URL (https://...)" required>
      </div>
      <div class="col-md-3">
        <input type="text" id="code" class="form-control" placeholder="Code" maxlength="8" required>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Shorten</button>
      </div>
      <div class="col-12 mt-1">
        <span id="form-msg" class="text-success small"></span>
      </div>
    </form>

    <div class="table-responsive shadow-sm">
      <table class="table table-striped table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Short Link</th>
            <th>Original URL</th>
            <th>Clicks</th>
            <th>Last Click</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="links-table">
        </tbody>
      </table>
    </div>
  </div>

  <div id="copy-alert" class="alert alert-success fade-alert hide" role="alert">Copied!</div>

<script>
const BASE_URL = "";

// UX: 'Copied!' popup
function showCopiedAlert() {
  const alertBox = document.getElementById("copy-alert");
  alertBox.textContent = "Copied!";
  alertBox.classList.remove("hide");
  setTimeout(() => alertBox.classList.add("hide"), 1200);
}

// Share menu: only manual close, no auto-close
let shareMenuDiv = null;
function shareShortLink(link) {
  // Mobile native share support
  if (navigator.share) {
    navigator.share({
      title: 'TinyLink',
      url: link,
      text: "Check out this short link:",
    });
    return;
  }
  // Remove any previous share menu
  if (shareMenuDiv) {
    shareMenuDiv.remove();
    shareMenuDiv = null;
  }
  // Build and show new share menu
  shareMenuDiv = document.createElement("div");
  shareMenuDiv.innerHTML = `
    <div class="dropdown-menu show"
      style="position:fixed;left:40%;top:30%;z-index:20000;padding:8px;">
      <a href="https://wa.me/?text=${encodeURIComponent(link)}" target="_blank" class="dropdown-item">WhatsApp</a>
      <a href="https://t.me/share/url?url=${encodeURIComponent(link)}" target="_blank" class="dropdown-item">Telegram</a>
      <button class="dropdown-item" onclick="this.closest('.dropdown-menu').remove();shareMenuDiv=null;">Close</button>
    </div>`;
  document.body.appendChild(shareMenuDiv.firstChild);
}

async function fetchLinks() {
  const res = await fetch(BASE_URL + "/api/links");
  const links = await res.json();
  const tbody = document.getElementById("links-table");
  tbody.innerHTML = "";
  links.forEach(link => {
    let shortLink = `${location.origin}/${link.code}`;
    tbody.innerHTML += `
      <tr>
        <td>
          <div class="short-link-wrap">
            <a href="${shortLink}" target="_blank" class="badge bg-primary text-wrap text-decoration-none" style="cursor:pointer" title="Open short link">${shortLink}</a>
            <button class="btn btn-outline-secondary btn-sm" onclick="navigator.clipboard.writeText('${shortLink}'); showCopiedAlert();" title="Copy">
              <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <rect x="9" y="9" width="13" height="13" rx="2" fill="none"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
              </svg>
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="shareShortLink('${shortLink}')" title="Share">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/>
              </svg>
            </button>
          </div>
        </td>
        <td style="word-break:break-all"><a href="${link.url}" target="_blank">${link.url}</a></td>
        <td class="text-center">${link.clicks}</td>
        <td class="text-muted">${link.last_clicked ? link.last_clicked.replace('T',' ').slice(0,16) : '-'}</td>
        <td class="text-center">
          <button onclick="deleteLink('${link.code}')" class="btn btn-danger btn-sm">Delete</button>
        </td>
      </tr>
    `;
  });
}

async function deleteLink(code) {
  if (confirm("Delete this link?")) {
    await fetch(BASE_URL + "/api/links/" + code, { method: "DELETE" });
    fetchLinks();
  }
}

document.getElementById("add-link-form").onsubmit = async (e) => {
  e.preventDefault();
  const url = document.getElementById("url").value;
  const code = document.getElementById("code").value;
  const msg = document.getElementById("form-msg");
  msg.textContent = "Adding...";
  try {
    let res = await fetch(BASE_URL + "/api/links", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ url, code })
    });
    let data = await res.json();
    if (res.ok) {
      msg.textContent = "Added!";
      fetchLinks();
    } else {
      msg.textContent = data.error || "Error!";
    }
  } catch {
    msg.textContent = "Network error";
  }
  setTimeout(() => (msg.textContent = ""), 2000);
};

fetchLinks();
</script>
</body>
</html>
